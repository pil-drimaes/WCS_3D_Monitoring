<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGV 실시간 모니터링</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .event-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .event-item {
            padding: 8px;
            margin: 4px 0;
            background-color: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
            border-left: 4px solid #007bff;
        }
        .event-time {
            color: #6c757d;
            font-size: 11px;
        }
        .coordinates {
            font-weight: bold;
            color: #007bff;
        }
        .refresh-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .refresh-btn:hover {
            background-color: #0056b3;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .stat-item {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            flex: 1;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h2>ETL 엔진 상태 모니터링</h2>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalAgvs">0</div>
                    <div class="stat-label">총 처리 레코드</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="lastUpdate">-</div>
                    <div class="stat-label">마지막 업데이트</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="eventCount">0</div>
                    <div class="stat-label">성공 레코드</div>
                </div>
            </div>
            <button class="refresh-btn" onclick="loadAgvData()">데이터 새로고침</button>
            <div id="status" class="status disconnected">WebSocket 연결 중...</div>
            <table id="agvTable">
                <thead>
                    <tr>
                        <th>구분</th>
                        <th>상태</th>
                        <th>처리 레코드</th>
                        <th>성공 레코드</th>
                        <th>마지막 실행</th>
                        <th>연결 상태</th>
                    </tr>
                </thead>
                <tbody id="agvTableBody">
                </tbody>
            </table>
        </div>
        
        <div class="card">
            <h2>실시간 이벤트</h2>
            <div class="event-list" id="eventList">
                <div class="event-item">이벤트를 기다리는 중...</div>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let eventCount = 0;

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                updateStatus(true);
                
                // AGV 업데이트 구독
                stompClient.subscribe('/topic/agv-updates', function (message) {
                    const events = JSON.parse(message.body);
                    console.log('Received AGV updates:', events);
                    
                    events.forEach(event => {
                        addEventToList(event);
                        eventCount++;
                        updateStats();
                    });
                    
                    // AGV 데이터 새로고침
                    loadAgvData();
                });
            }, function(error) {
                console.log('STOMP error: ' + error);
                updateStatus(false);
                setTimeout(connect, 5000); // 5초 후 재연결 시도
            });
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'WebSocket 연결됨 - 실시간 업데이트 활성화';
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'WebSocket 연결 끊김 - 재연결 시도 중...';
            }
        }

        function addEventToList(event) {
            const eventList = document.getElementById('eventList');
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event-item';
            
            try {
                const agvData = JSON.parse(event.payload);
                const now = new Date().toLocaleTimeString();
                
                eventDiv.innerHTML = `
                    <div class="event-time">${now}</div>
                    <strong>${agvData.agvId}</strong> - 
                    <span class="coordinates">(${agvData.x}, ${agvData.y})</span>
                    <br>
                    <small>${agvData.timestamp}</small>
                `;
            } catch (e) {
                eventDiv.innerHTML = `
                    <div class="event-time">${new Date().toLocaleTimeString()}</div>
                    <strong>${event.type}</strong> - ${event.payload}
                `;
            }
            
            eventList.insertBefore(eventDiv, eventList.firstChild);
            
            // 최대 50개 이벤트만 유지
            while (eventList.children.length > 50) {
                eventList.removeChild(eventList.lastChild);
            }
        }

        async function loadAgvData() {
            try {
                const response = await fetch('/api/etl/status');
                const etlStatus = await response.json();
                
                const tbody = document.getElementById('agvTableBody');
                tbody.innerHTML = '';
                
                // ETL 상태 정보를 테이블에 표시
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>ETL Engine</td>
                    <td><strong>${etlStatus.engineHealthy ? '정상' : '오류'}</strong></td>
                    <td>${etlStatus.statistics.totalProcessedRecords}</td>
                    <td>${etlStatus.statistics.successfulRecords}</td>
                    <td>${new Date(etlStatus.lastExecutionTime).toLocaleString()}</td>
                    <td>WCS 연결: ${etlStatus.wcsConnected ? '정상' : '오류'}</td>
                `;
                tbody.appendChild(row);
                
                updateStats();
            } catch (error) {
                console.error('Error loading ETL status:', error);
                // 에러 발생 시 테이블에 에러 메시지 표시
                const tbody = document.getElementById('agvTableBody');
                tbody.innerHTML = '<tr><td colspan="6" style="color: red;">데이터 로드 실패</td></tr>';
            }
        }

        function updateStats() {
            // ETL 상태에서 통계 정보 업데이트
            fetch('/api/etl/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalAgvs').textContent = data.statistics.totalProcessedRecords;
                    document.getElementById('eventCount').textContent = data.statistics.successfulRecords;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                })
                .catch(error => {
                    console.error('Error updating stats:', error);
                });
        }

        // 페이지 로드 시 실행
        window.onload = function() {
            connect();
            loadAgvData();
            
            // 30초마다 데이터 새로고침 (백업용)
            setInterval(loadAgvData, 30000);
        };
    </script>
</body>
</html> 